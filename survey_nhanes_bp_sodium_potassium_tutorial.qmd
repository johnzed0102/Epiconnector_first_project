---
title: "NHANES 2003–2006: Sodium, Potassium, and Blood Pressure"
subtitle: "A Survey-Weighted Regression Example with phonto"
author: "Johnny Zhao"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: false
    code-tools: true
  pdf:
    toc: true
    toc-depth: 3
    keep-tex: true
execute:
  warning: false
  message: false
  echo: true
  include: true
vignette: >
  %\VignetteIndexEntry{NHANES Sodium, Potassium, and Blood Pressure (Survey Analysis)}
  %\VignetteEngine{quarto}
  %\VignetteEncoding{UTF-8}
---

# 1. Introduction

In this vignette, we reproduce and extend a textbook analysis of the relationship between dietary sodium, dietary potassium, and blood pressure using NHANES data from 2003–2006.\
Our primary goals are to demonstrate **reproducible analysis workflows** using the **Epiconnector** ecosystem and the **NHANES Docker instance**, ensuring that every step—from data retrieval to model fitting—can be replicated without manual downloads.

Specifically, we show how to:

-   Retrieve and merge NHANES datasets programmatically using the Epiconnector tools (`phonto` and `nhanesA`) within the Docker environment.
-   Apply the appropriate survey weights to account for NHANES’s complex sampling design.
-   Fit survey-weighted regression models to estimate associations between nutrient intake and systolic/diastolic blood pressure.
-   Compare the reproduced results with those presented in the textbook to validate reproducibility.

For background on **what NHANES is** and **how to access it reproducibly**, readers are referred to the companion paper:

> *Laha Ale, Robert Gentleman, Christopher Endres, Sam Pullman, Nathan Palmer, Rafael Goncalves, and Deepayan Sarkar.* (in press). **Enhancing Statistical Analysis of Real World Data.**
>
> (Available as `NHANESpaper.Rmd` in the `phonto` vignettes.)

That paper provides an overview of the Epiconnector framework and demonstrates how NHANES data can be accessed and analyzed reproducibly within a Docker environment.

This vignette complements it by reproducing a textbook example to illustrate how the Epiconnector–Docker setup supports transparent and reproducible epidemiologic analysis.

# 2. Packages

We begin by loading the packages required for data extraction, processing, and analysis.

-   `phonto` and `nhanesA`: provide programmatic access to NHANES variables and allow flexible queries across cycles.

-   survey: provides tools for creating complex survey designs and fitting weighted regression models.

```{r}
library(phonto)
library(nhanesA)
library(survey)
library(dplyr)
library(tidyr)
library(hexbin)
library(knitr)
library(kableExtra)
library(ggplot2)
library(splines)
```

# 3. Data Sources

The textbook example uses NHANES 2003–2006, combining two 2-year cycles (2003–2004 \[C\] and 2005–2006 \[D\]), which we reproduce here using Epiconnector for fully programmatic access. To reproduce the textbook faithfully while keeping the workflow reproducible, we query the original NHANES tables by cycle and retain **only the variables used downstream**, always by **name** (no numeric indexing).

-   **DEMO (both cycles)**\
    We keep the 12 design and demographic fields needed for survey weighting and covariates: `SEQN, RIAGENDR, RIDAGEYR, WTINT2YR, WTMEC2YR, SDMVPSU, SDMVSTRA`.

-   **BPX (both cycles)**\
    Blood pressure outcomes (`BPXSAR` for systolic, `BPXDAR` for diastolic) are used when present. To mirror the textbook, for D-cycle records that lack pre-averaged values we compute means from the replicate readings (`BPXSY1–4`, `BPXDI1–4`) with `na.rm = TRUE`. The replicate columns are retained solely for this computation/QC.

-   **BMX (both cycles)**\
    We keep `SEQN` and `BMXBMI` as the obesity covariate.

-   **DR1TOT (both cycles)**\
    We retain the dietary Day-1 weight `WTDRD1` and the sodium/potassium intake variables `DR1TSODI` and `DR1TPOTA`(later expressed in g/day). These are the only DR1TOT fields used in analysis.

After cycle-level retrieval, we harmonize columns, **row-bind C and D**, and derive analysis variables: sodium and potassium in **g/day** and a **four-year weight** `fouryearwt = WTDRD1 / 2`. This mirrors the textbook while aligning with our reproducible pipeline (name-based keeps, minimal variables, and explicit handling of D-cycle BP means).

**Code: declare the targets we will keep (for the upcoming extraction/wrangling)**

```{r}
# --- Keep lists by *names*, minimal set for analysis ---
# DEMO: exact 12 variables (C and D)
DEMO_keep <- c("SEQN","RIAGENDR","RIDAGEYR",
               "WTINT2YR","WTMEC2YR","SDMVPSU","SDMVSTRA")

# BPX: only what's needed for analysis + manual averages for 2005–06 if missing
BPX_keep <- c(
  "SEQN",
  "BPXSAR","BPXDAR",          # precomputed (present in 2003–04; may be NA in 2005–06)
  "BPXSY1","BPXSY2","BPXSY3","BPXSY4",  # raw systolic repeats
  "BPXDI1","BPXDI2","BPXDI3","BPXDI4"   # raw diastolic repeats
)

BPX_keep_D <- setdiff(BPX_keep, c("BPXSAR","BPXDAR"))

# BMX: SEQN + BMI (C and D)
BMX_keep <- c("SEQN","BMXBMI")

# DR1TOT: keep only what we actually use
# - WTDRD1: dietary day 1 weight (textbook uses this, then /2 for four-year)
# - DR1TSODI, DR1TPOTA: sodium & potassium (mg/day)
DR1TOT_keep <- c("SEQN","WTDRD1","DR1TSODI","DR1TPOTA")

# For downstream checks
DIET_named_vars <- c("DR1TSODI","DR1TPOTA")

# ---- jointQuery() column map (follow quick_start line ~224 pattern) ----
cols_c <- list(DEMO_C = DEMO_keep,
               BPX_C = BPX_keep,
               BMX_C = BMX_keep,
               DR1TOT_C = DR1TOT_keep)

cols_d <- list(DEMO_D = DEMO_keep,
               BPX_D = BPX_keep_D,
               BMX_D = BMX_keep,
               DR1TOT_D = DR1TOT_keep)

# Will then use：
# data <- jointQuery(cols)
```

# 4. Data Extraction

We retrieve the four domains (**DEMO, BPX, BMX, DR1TOT**) for each NHANES cycle and let the database do the joins. Following the textbook while keeping the pipeline reproducible, our workflow is:

1.  For each cycle, declare a name-based keep list (no numeric indexing) and call the tables by their cycle-tagged names (e.g., `DEMO_C`, `BPX_D`).

2.  Use a single database call to **join within cycle by `SEQN`**, producing one tidy file per cycle: `nhanes34` (C) and `nhanes56` (D).

3.  Do not perform transformations here. Unit conversions and the four-year weight are created in the next section. For the D cycle only, we compute **`BPXSAR`/`BPXDAR` from replicate readings** when the pre-averaged values are absent, matching the textbook’s approach.

### 4.1. Cycle C (2003–2004)

For the C cycle we select the textbook columns for DEMO, keep BMI from BMX, and keep the BP outcomes along with their replicates. We then perform a single database join on `SEQN` to obtain **`nhanes34`**, a cycle-level analytic file ready for later stacking.

```{r}
# Cycle C (2003–2004): pull and merge with jointQuery
nhanes34 <- jointQuery(cols_c)
```

### 4.2. Cycle D (2005–2006)

For the D cycle we use the same keep lists, but the BP table may lack pre-averaged outcomes. After joining by `SEQN` to create **`nhanes56`**, we compute **`BPXSAR`** and **`BPXDAR`** from the four replicate readings (`BPXSY1–4`, `BPXDI1–4`, using `na.rm = TRUE`) only when needed. This defers all other transformations to the preprocessing section and keeps the extraction logic parallel across cycles.

```{r}
# Cycle D (2005–2006): pull and merge with jointQuery and add BPXSAR, BPXDAR
nhanes56 <- jointQuery(cols_d)

nhanes56$BPXSAR <- rowMeans(nhanes56[, c("BPXSY1", "BPXSY2", "BPXSY3", "BPXSY4")], 
                            na.rm = TRUE)
nhanes56$BPXDAR <- rowMeans(nhanes56[, c("BPXDI1", "BPXDI2", "BPXDI3", "BPXDI4")], 
                            na.rm = TRUE)
```

# 5. Data Cleaning and Preprocessing

In this section, we harmonize the C and D cycle files and prepare analysis-ready fields. We stack the cycle-level datasets (`nhanes34` and `nhanes56`) to mirror the textbook workflow, then derive key variables for sodium, potassium, and the four-year dietary weight.

```{r}
# Combine C and D cycles
nhanes <- rbind(nhanes34, nhanes56)

# Derive analysis variables
nhanes$sodium <- nhanes$DR1TSODI / 1000
nhanes$potassium <- nhanes$DR1TPOTA / 1000
nhanes$fouryearwt <- nhanes$WTDRD1 / 2

# Remove records with missing dietary weights before creating the survey design
nhanes <- subset(nhanes, !is.na(WTDRD1))

# Remove extreme BMI outlier (~130)
nhanes <- subset(nhanes, is.na(BMXBMI) | BMXBMI < 80)
```

Finally, we remove records with missing **WTDRD1** values before creating the survey design, following the `survey` package requirement that weights be non-missing.

Note: Dietary weights (WTDRD1) are only available for participants who completed the dietary recall interview, which typically excludes younger children. Therefore, by restricting the dataset to records with valid WTDRD1, younger participants are implicitly filtered out. This ensures that our analytic sample corresponds to the population eligible for dietary assessment in NHANES.

## 5.1. Cohort Description Table

To summarize the analytic cohort, we construct a descriptive table using the `tableone` package. This “Descriptive Table” reports key demographic and analytic variables — age, gender, BMI, dietary sodium and potassium, and systolic blood pressure — stratified by gender. Such tables are standard in epidemiologic reporting and allow us to verify sample representativeness before model fitting.

```{r}
## Descriptive Table 1
## Publication-style summary of analytic variables by gender (NHANES 2003–2006)
# Build continuous summary: mean ± SD
cont_summary <- nhanes |>
  group_by(RIAGENDR) |>
  summarise(
    N = n(),
    `Age (yrs), mean ± SD` = sprintf("%.1f ± %.1f", mean(RIDAGEYR, na.rm = TRUE), sd(RIDAGEYR, na.rm = TRUE)),
    `BMI (kg/m²), mean ± SD` = sprintf("%.1f ± %.1f", mean(BMXBMI, na.rm = TRUE), sd(BMXBMI, na.rm = TRUE)),
    `Sodium (mg/day), mean ± SD` = sprintf("%.0f ± %.0f", mean(sodium, na.rm = TRUE), sd(sodium, na.rm = TRUE)),
    `Potassium (mg/day), mean ± SD` = sprintf("%.0f ± %.0f", mean(potassium, na.rm = TRUE), sd(potassium, na.rm = TRUE)),
    `Systolic BP (mmHg), mean ± SD` = sprintf("%.1f ± %.1f", mean(BPXSAR, na.rm = TRUE), sd(BPXSAR, na.rm = TRUE))
  ) |>
  rename(gender = RIAGENDR)

# Add overall row
overall <- nhanes |>
  summarise(
    N = n(),
    `Age (yrs), mean ± SD` = sprintf("%.1f ± %.1f", mean(RIDAGEYR, na.rm = TRUE), sd(RIDAGEYR, na.rm = TRUE)),
    `BMI (kg/m²), mean ± SD` = sprintf("%.1f ± %.1f", mean(BMXBMI, na.rm = TRUE), sd(BMXBMI, na.rm = TRUE)),
    `Sodium (mg/day), mean ± SD` = sprintf("%.0f ± %.0f", mean(sodium, na.rm = TRUE), sd(sodium, na.rm = TRUE)),
    `Potassium (mg/day), mean ± SD` = sprintf("%.0f ± %.0f", mean(potassium, na.rm = TRUE), sd(potassium, na.rm = TRUE)),
    `Systolic BP (mmHg), mean ± SD` = sprintf("%.1f ± %.1f", mean(BPXSAR, na.rm = TRUE), sd(BPXSAR, na.rm = TRUE))
  ) |>
  mutate(gender = "All") |>
  dplyr::select(gender, everything())

tab_cont <- bind_rows(overall, cont_summary) |>
  mutate(gender = recode(gender, `1` = "Male", `2` = "Female"))

# Dummy categorical summary – replace with true categories if present
cat_summary <- data.frame(
  Category = c("gender, n (%)", "   Male", "   Female"),
  All = c(nrow(nhanes),
          sum(nhanes$RIAGENDR == 1, na.rm = TRUE),
          sum(nhanes$RIAGENDR == 2, na.rm = TRUE)),
  Male = c("-", "-", "-"),
  Female = c("-", "-", "-")
)

# Merge continuous and categorical sections for layout
tab_display <- tab_cont |>
  rename(`Variable` = gender) |>
  mutate(`Variable` = c("All", "Male", "Female")) |>
  dplyr::select(`Variable`, everything())

```

```{r}
#| label: tbl-descriptive

# Create the formatted table
kbl(
  tab_display,
  caption = "Descriptive characteristics of the analytic sample (NHANES 2003–2006).",
  booktabs = TRUE,
  align = "lcccccc"
) |>
  kable_styling(
    bootstrap_options = c("striped", "condensed"),
    full_width = FALSE,
    font_size = 11,
    position = "center"
  ) |>
  row_spec(0, bold = TRUE, align = "center") |>
  add_header_above(c(" " = 1, "Summary Statistics" = 6), bold = TRUE, line = TRUE) |>
  pack_rows("Demographic and Clinical Characteristics", 1, 3, bold = TRUE, italic = FALSE) |>
  footnote(
    general = "Values are mean ± SD unless otherwise indicated. BP = blood pressure.",
    general_title = "Note: ",
    threeparttable = TRUE
  )
```

As shown in @tbl-descriptive, which provides a descriptive overview of the analytic cohort and allows us to verify that the NHANES participants included in the analysis are representative of the target population. It also serves as a baseline comparison across gender, showing expected demographic and dietary differences — for example, higher mean sodium and potassium intake among males. Such descriptive tables ensure transparency and reproducibility prior to model fitting.

## 5.2. Exploratory Visualization: Age and BMI Distributions

To further visualize sample characteristics before model fitting, we examined the joint distribution of age and BMI. We divided the cohort into 10 equal age groups (deciles) and plotted BMI distributions for males and females separately. This exploratory plot helps detect nonlinear or interaction patterns that may justify flexible modeling terms such as splines or age × gender interactions.

```{r}
#| label: fig-exploratory-boxplots
#| echo: true
#| message: false
#| warning: false
#| fig.width: 8
#| fig.height: 4

# Create age groups by decades (0–10, 10–20, ..., up to 80+)
nhanes <- nhanes |>
  mutate(age_group = cut(
    RIDAGEYR,
    breaks = seq(0, 90, by = 10),
    include.lowest = TRUE,
    right = FALSE,
    labels = c("0–9", "10–19", "20–29", "30–39", "40–49",
               "50–59", "60–69", "70–79", "80+")
  ))

# Boxplot: BMI vs age decile by gender
ggplot(nhanes, aes(x = age_group, y = BMXBMI, fill = factor(RIAGENDR))) +
  geom_boxplot(outlier.size = 0.8, alpha = 0.7) +
  scale_fill_manual(
    values = c("#5DADE2", "#F5B7B1"),
    name = "gender", labels = c("Male", "Female")
  ) +
  labs(
    title = "Distribution of BMI across Age Deciles by gender",
    x = "Age Decile (10 equal groups)",
    y = "BMI (kg/m²)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

As shown in @fig-exploratory-boxplots, BMI tends to increase with age up to midlife, with males showing slightly higher medians across most age deciles.

At older ages, both genderes display greater variability and a mild plateauing of median BMI, suggesting potential nonlinearity and heteroscedasticity in the age–BMI relationship that will later be modeled using natural splines.

# 6. Survey Design

We now build the NHANES complex survey design to mirror the textbook analysis. Strata and primary sampling units are SDMVSTRA and SDMVPSU, and the analytic weight is the Day-1 dietary weight (WTDRD1). Because we combine two 2-year cycles (2003–2004 and 2005–2006), we construct a four-year weight defined as fouryearwt = WTDRD1 / 2. Before creating the survey design object, we exclude records with missing WTDRD1 because the survey package requires non-missing weights. All other missing values—including dietary sodium and potassium—are retained until after the design is created. This ensures that the full sampling structure is preserved. After defining the design, we then subset out participants with missing sodium or potassium values.

```{r}
options(survey.lonely.psu = "adjust")

# Create design with full dataset (weights now complete)
des <- svydesign(
  id = ~SDMVPSU,
  strata = ~SDMVSTRA,
  weights = ~fouryearwt,
  nest = TRUE,
  data = nhanes
)

# Remove records with missing sodium or potassium AFTER defining the design
des <- subset(des, !is.na(DR1TSODI) & !is.na(DR1TPOTA))

# (Optional) verify sodium/potassium variables
if (!all(c("sodium","potassium") %in% names(des$variables))) {
  des <- update(
    des,
    sodium = DR1TSODI / 1000,
    potassium = DR1TPOTA / 1000
  )
}
```

**Notes**

-   `options(survey.lonely.psu = "adjust")` stabilizes variance estimation when some strata contain only a single Primary Sampling Unit (PSU), known as a *lonely PSU*. In such cases, the `survey` package applies an adjustment to prevent underestimation or failure of variance calculations, ensuring stable standard error estimates.
-   `nest = TRUE` treats PSUs as nested within strata across combined cycles, which is standard for NHANES.
-   We remove records with missing `WTDRD1` **before** creating the survey design, as required by the `survey` package, but retain all other missing values until **after** defining the design. This preserves the correct sampling variance structure.
-   `WTINT2YR` and `WTMEC2YR` remain in the dataset for completeness/QC, though dietary analyses use the four-year weight (`WTDRD1 / 2`).
-   BP means (SBP/DBP) were computed only once during data extraction for the D cycle.
-   Sodium and potassium (g/day) are added or verified in the design object using `survey::update()` to maintain consistency with the textbook and the workflow used in `survey_weights_tutorial.rmd`.

# 7. Models

## 7.1. Linear Models: Baseline Associations

We start by fitting **survey-weighted linear models** for *systolic blood pressure (BPXSAR)*, following the textbook’s stepwise approach:

-   **Model 0:** sodium + potassium *(unadjusted)*

-   **Model 1:** Model 0 + age *(RIDAGEYR)*

-   **Model 2:** Model 1 + gender *(RIAGENDR)*

-   **Model 3:** Model 2 + BMI *(BMXBMI)*

Each model adds one potential confounder to evaluate how the associations between dietary sodium, potassium, and blood pressure evolve as we account for more covariates.

We estimated a sequence of survey-weighted regression models to examine how the associations between sodium, potassium, and blood pressure evolve with increasing adjustment.

-   Model 0 includes only sodium and potassium (unadjusted).

-   Model 1 adds age to control for confounding by age.

-   Model 2 adds gender, and Model 3 adds BMI to form a fully adjusted model.

-   Age was centered at 40 years (RIDAGEYR – 40) so that coefficients represent effects at mid-adulthood.

A joint test using `regTermTest()` assesses whether sodium and potassium jointly contribute to each model; and shifts in coefficient signs or magnitudes across models reflect the extent of confounding adjustment.

```{r}
# --- Systolic blood pressure (SBP) models ---
m0 <- svyglm(BPXSAR ~ sodium + potassium, design = des)
m1 <- svyglm(BPXSAR ~ sodium + potassium + RIDAGEYR, design = des)
m2 <- svyglm(BPXSAR ~ sodium + potassium + RIDAGEYR + RIAGENDR, design = des)
m3 <- svyglm(BPXSAR ~ sodium + potassium + RIDAGEYR + RIAGENDR + BMXBMI, design = des)

# summary(m0); summary(m1); summary(m2); summary(m3)

# Joint (Wald) test for sodium & potassium in the fully adjusted SBP model
wald_sbp <- regTermTest(m3, ~ potassium + sodium, df = NULL)
```

We repeat the same stepwise specification for **diastolic blood pressure (BPXDAR)**, producing models *m4–m7* that directly correspond to the systolic series (*m0–m3*).

```{r}
# --- Diastolic blood pressure (DBP) models ---
m4 <- svyglm(BPXDAR ~ sodium + potassium, design = des)
m5 <- svyglm(BPXDAR ~ sodium + potassium + RIDAGEYR, design = des)
m6 <- svyglm(BPXDAR ~ sodium + potassium + RIDAGEYR + RIAGENDR, design = des)
m7 <- svyglm(BPXDAR ~ sodium + potassium + RIDAGEYR + RIAGENDR + BMXBMI, design = des)

# summary(m4); summary(m5); summary(m6); summary(m7)
```

The table below summarizes the associations between sodium, potassium, and blood pressure across the stepwise model sequence. To avoid manual transcription and ensure reproducibility, we programmatically extract the coefficients and standard errors from the fitted models using `knitr::kable()`.

```{r}
#| label: tbl-association
#| echo: true
#| message: false
#| warning: false

# Helper: extract sodium & potassium rows from svyglm() summaries
coef_table <- function(mod_list, model_names, keep_terms = c("sodium","potassium")) {
  do.call(rbind, lapply(seq_along(mod_list), function(i) {
    s <- summary(mod_list[[i]])
    co <- coef(s)
    co <- co[rownames(co) %in% keep_terms, , drop = FALSE]
    data.frame(
      model = model_names[i],
      term  = rownames(co),
      estimate = co[, "Estimate"],
      se       = co[, "Std. Error"],
      p_value  = co[, "Pr(>|t|)"],
      row.names = NULL
    )
  }))
}

# Build tidy tables for SBP and DBP model sets
tab_sbp <- coef_table(list(m0, m2, m3),
                      c("Unadjusted", "Age+gender","Age+gender+BMI"))
tab_dbp <- coef_table(list(m4, m6, m7),
                      c("Unadjusted", "Age+gender","Age+gender+BMI"))
fmt <- function(est, se) sprintf("%.2f (%.2f)", est, se)
ord <- c("Unadjusted", "Age and gender","Age, gender, BMI")

# Wide SBP
sbp_wide <- tab_sbp |>
  transform(value = fmt(estimate, se),
            term = ifelse(term=="sodium","Systolic BP Sodium","Systolic BP Potassium")) |>
  subset(select = c(model, term, value)) |>
  tidyr::pivot_wider(names_from = term, values_from = value) |>
  dplyr::arrange(factor(model, levels = ord)) |>
  dplyr::rename(Model = model)

# Wide DBP
dbp_wide <- tab_dbp |>
  transform(value = fmt(estimate, se),
            term = ifelse(term=="sodium","Diastolic BP Sodium","Diastolic BP Potassium")) |>
  subset(select = c(model, term, value)) |>
  tidyr::pivot_wider(names_from = term, values_from = value) |>
  dplyr::arrange(factor(model, levels = ord)) |>
  dplyr::rename(Model = model)

# Join into one Table 1
table1a <- dplyr::left_join(sbp_wide, dbp_wide, by = "Model")
knitr::kable(
  table1a,
  caption = "Associations between dietary sodium and potassium and blood pressure in NHANES 2003–2006.",
  booktabs = TRUE,
  align = c("l","c","c","c","c")
)
```

-   The unadjusted model shows sodium and potassium moving in opposite directions from what we expect biologically.

-   Once age is added, the signs of both coefficients reverse.

-   This large shift indicates a **strong confounding effect of age**, as older participants tend to have higher blood pressure but consume less sodium and potassium.

-   The direction and magnitude of effects in diastolic blood pressure are consistent with those for systolic BP.

-   Adjusting for age again reverses the sign of sodium and potassium coefficients.

-   Further adjustments for gender and BMI make little difference, suggesting that age remains the key confounder.

The estimates in @tbl-association reproduce the sequence of models discussed in Lumley’s *Complex Surveys* chapter on NHANES 2003–2006. To make the correspondence explicit, we include below the original table from the textbook.

::: {#fig-table-textbook}
![Table 5.1 from Lumley (Complex Surveys, NHANES 2003–2006).](images/clipboard-3948312674.png)
:::

As shown in @fig-table-textbook, our reproduced estimates align closely with the structure and interpretation of the textbook results. However, a detailed comparison between @tbl-association and Lumley (2010) textbook Table 5.1 reveals several important discrepancies that highlight the necessity of code-based reproducibility.

**1. Model structure remains identical.**\
Both tables report an unadjusted model, then models adjusted for age, age + gender, and age + gender + BMI. The intended confounding narrative (age reversing coefficient signs) is preserved.

**2. Systolic BP (BPXSAR): only standard errors changed.**\
For systolic blood pressure models, our coefficient *estimates* match those in the textbook.\
The **only difference** lies in the **standard errors**, which differ slightly; likely caused by unreported filtering and undocumented preprocessing steps in the textbook. Because our pipeline explicitly preserves all transformations and survey design handling, these values are fully traceable and reproducible from code.

**3. Diastolic BP (BPXDAR): more substantial differences emerge.**\
In contrast to systolic BP, diastolic BP shows **overt numerical changes**. Notably, in the **fully adjusted model (Age + gender + BMI)**, both sodium and potassium coefficients differ from the textbook:

| Model              | Variable  | Textbook Estimate | Our Estimate    |
|--------------------|-----------|-------------------|-----------------|
| Age + gender + BMI | Sodium    | **0.34 (0.10)**   | **0.19 (0.10)** |
| Age + gender + BMI | Potassium | **0.25 (0.19)**   | **0.37 (0.18)** |

These differences cannot be attributed to sampling variation alone — rather, they are likely a consequence of **copy–paste transcription** in the textbook. Because no reproducible code is provided, it is impossible to verify the original analytical pipeline or confirm any sample filtering or weighting decisions.

This vignette does not simply “replicate” the textbook, it corrects it. Our workflow is:

-   **fully code-driven** (all tables generated directly from R output),

-   **transparent** (all transformations are explicit), and

-   **scientifically auditable**.

By contrast, Table 5.1 in the textbook appears to have been manually transcribed. Occasional inconsistencies, including the ones observed here. Suggesting that copy/paste errors occurred during table construction. Without accompanying code, such errors cannot be detected or corrected, making strict reproducibility impossible.

The comparison demonstrates the core strength of the Epiconnector-based workflow:\
\> **Every number in this vignette can be reproduced — or challenged — directly from code.**

This aligns with modern expectations for statistical reporting and illustrates how programmatic workflows prevent transcription errors and promote reproducible teaching materials. Rather than reproducing the textbook table, we provide a *more reliable* version of it.

To evaluate model adequacy and assess whether adjusting for demographic and health variables improves model fit, we compare residual diagnostics across three specifications:

1.  Model 0 – Unadjusted

2.  Model 1 – Adjusted for Age

3.  Model 2 – Adjusted for Age + Gender

4.  Model 3 – Fully Adjusted (Age + Gender + BMI)

Residual plots based on simple scatter + LOWESS were visually noisy and not fully informative for detecting subtle structure. Following advisor feedback, we instead use `smoothScatter()` and `hexbin()` to better visualize density & heteroskedasticity, especially near the center of mass.

```{r}
#| label: fig-residual-diagnostics-1
#| echo: true
#| message: false
#| warning: false
#| fig.width: 7
#| fig.height: 4

# Model 0 – no adjustment
smoothScatter(fitted(m0), resid(m0), main = "Model 0 (Unadjusted)")
hb0 <- hexbin(fitted(m0), resid(m0))
plot(hb0, main = "Model 0 (hexbin)")
```

The residuals in Model 0 show a fairly symmetric cloud centered around zero, with no strong curvature or pattern; suggesting no major misspecification. However, there is visible heteroskedasticity, with greater spread at higher fitted values, indicating that key covariates (e.g., age) are still missing and likely explainable variation remains.

```{r}
#| label: fig-residual-diagnostics-2
#| echo: true
#| message: false
#| warning: false
#| fig.width: 7
#| fig.height: 4

# Model 1 – age only
smoothScatter(fitted(m1), resid(m1), main = "Model 1 – Age Adjusted")
hb1 <- hexbin(fitted(m1), resid(m1))
plot(hb1, main = "Model 1 (hexbin)")
```

For Model 1, adjusting for age noticeably reduces heteroskedasticity compared to the unadjusted model. The residuals are more concentrated around zero, and the central density becomes narrower, indicating that age explains a substantial portion of variation previously unaccounted for. However, some spread remains at both tails, suggesting additional covariates may still be needed for full adjustment.

```{r}
#| label: fig-residual-diagnostics-3
#| echo: true
#| message: false
#| warning: false
#| fig.width: 7
#| fig.height: 4

# Model 2 – age + gender
smoothScatter(fitted(m2), resid(m2), main = "Model 2 – Age + Gender")
hb2 <- hexbin(fitted(m2), resid(m2))
plot(hb2, main = "Model 2 (hexbin)")
```

After adjusting for both age and gender, the residuals remain centered around zero with slightly reduced dispersion compared to Model 1. The central density becomes narrower, but the tails still show mild heteroscedasticity, indicating that some unexplained variation remains. Gender contributes modest additional adjustment, but age appears to be the primary driver of improvement in model fit.

```{r}
#| label: fig-residual-diagnostics-4
#| echo: true
#| message: false
#| warning: false
#| fig.width: 7
#| fig.height: 4

# Model 3 – fully adjusted
smoothScatter(fitted(m3), resid(m3),  main = "Model 3 – Fully Adjusted")
hb3 <- hexbin(fitted(m3), resid(m3))
plot(hb3, main = "Model 3 (hexbin)")
```

Model 3 shows the highest concentration of residuals around zero and the smallest dispersion among all models, indicating the best overall fit. Adding BMI yields modest improvement beyond the age- and gender-adjusted model, suggesting that BMI accounts for some additional unexplained variation. However, most of the reduction in heteroscedasticity occurs after age adjustment, reinforcing that age is the primary confounder in this relationship.

Across all the specifications, age emerges as the key confounding variable. Once age is included, sodium shows a small positive association with blood pressure, while potassium remains inversely associated. Further adjustment for gender and BMI produces comparatively minor changes, indicating that the essential structure of the association is captured after controlling for age. Effect sizes remain modest, consistent with the textbook’s conclusion that sodium and potassium have statistically significant but small impacts on blood pressure after accounting for relevant confounders.

## 7.2. Flexible Models: Splines and Age×Sex Interactions

Age is a continuous covariate whose effect on blood pressure may vary across the life course and differ between men and women. Previous results showed that age was the primary confounder in the association between sodium, potassium, and blood pressure. However, assuming a strictly linear age effect may oversimplify the relationship and mask meaningful patterns in different age ranges.

To address this, we extend the models by using a **natural spline transformation of age**, allowing the association between age and blood pressure to vary smoothly rather than forcing a linear trend. Additionally, based on prior evidence and biological reasoning that *blood pressure trajectories differ by gender across age groups*, we include an **age × gender interaction term**. This specification enables gender-specific age effects and directly tests whether males and females exhibit different blood pressure patterns at different stages of life.

This sensitivity analysis evaluates whether relaxing linearity and allowing gender differences in age effects **improves model fit**, **reduces residual structure**, and **yields more realistic effect estimates**. The model structure remains unchanged except for replacing `age` with `ns(age)` and optionally adding the interaction term.

### 7.2.1. Model fitting

Models `m1_ns` – `m7_ns` mirror `m1` – `m7` but replace linear age with natural spline.

```{r}
# Update survey design to include natural spline of age
df_age <- 4
des <- update(
  des,
  age_ns = splines::ns(RIDAGEYR, df = df_age),
  agec = RIDAGEYR - 40
)

# --- SBP models with natural spline for age ---
m1_ns <- svyglm(BPXSAR ~ sodium + potassium + age_ns, design = des)
m2_ns <- svyglm(BPXSAR ~ sodium + potassium + age_ns + RIAGENDR, design = des)
m3_ns <- svyglm(BPXSAR ~ sodium + potassium + age_ns + RIAGENDR + BMXBMI, design = des)

# --- DBP models with natural spline for age ---
m5_ns <- svyglm(BPXDAR ~ sodium + potassium + age_ns, design = des)
m6_ns <- svyglm(BPXDAR ~ sodium + potassium + age_ns + RIAGENDR, design = des)
m7_ns <- svyglm(BPXDAR ~ sodium + potassium + age_ns + RIAGENDR + BMXBMI, design = des)

# --- Spline models with age × gender interaction ---
m2_ns_int <- svyglm(BPXSAR ~ sodium + potassium + RIAGENDR * age_ns, design = des)
m3_ns_int <- svyglm(BPXSAR ~ sodium + potassium + RIAGENDR * age_ns + BMXBMI, design = des)
m6_ns_int <- svyglm(BPXDAR ~ sodium + potassium + RIAGENDR * age_ns, design = des)
m7_ns_int <- svyglm(BPXDAR ~ sodium + potassium + RIAGENDR * age_ns + BMXBMI, design = des)
```

These spline-based models mirror the fully adjusted linear models (`m3` and `m7`) but allow the effect of age on blood pressure to vary smoothly rather than linearly. We used four degrees of freedom (df = 4)。

### 7.2.2. Visual comparison of model fit

To assess whether nonlinear age terms and the age × gender interaction improve model fit, we compare residual patterns from the three fully adjusted models (linear, spline, and spline × gender). Using `smoothScatter()` with a LOWESS trend, we look for reduced curvature and tighter clustering around zero as evidence of better specification.

```{r}
#| label: fig-m3-residual-plots
#| echo: true
#| message: false
#| warning: false
#| fig.width: 8
#| fig.height: 4

# Compare residuals of linear, ns, and ns-int models
par(mfrow = c(1, 3))

smoothScatter(fitted(m3), resid(m3), main = "Linear Age + Gender + BMI", 
              xlab = "Fitted values", ylab = "Residuals")
lines(lowess(fitted(m3), resid(m3)), col = "red", lwd = 2)

smoothScatter(fitted(m3_ns), resid(m3_ns), main = "Spline Age + Gender + BMI",
              xlab = "Fitted values", ylab = "Residuals")
lines(lowess(fitted(m3_ns), resid(m3_ns)), col = "red", lwd = 2)

smoothScatter(fitted(m3_ns_int), resid(m3_ns_int), main = "Spline Age × Gender + BMI",
              xlab = "Fitted values", ylab = "Residuals")
lines(lowess(fitted(m3_ns_int), resid(m3_ns_int)), col = "red", lwd = 2)

par(mfrow = c(1, 1))
```

Across the three models, residual dispersion and concentration around zero are broadly similar, indicating that the linear specification already captures most of the age-related variation. However, the LOWESS trend in the spline × gender model is slightly flatter and more centered than the other two. This suggests a modest gain in model adequacy when both nonlinear age effects and gender differences are accommodated. The improvement is incremental rather than substantial, but it supports the idea that age–gender interaction captures small structure that the linear model leaves unexplained.

### 7.2.3. Comparison of Model Specifications: Linear, Spline, and Age×Gender Interactions

In this section, we consolidate all model specifications to compare how the associations between sodium and potassium intake and blood pressure vary across increasingly complex adjustments. Specifically, we begin with linear age models (`m0`–`m7`), followed by spline-based models (`m1_ns`–`m7_ns`), and finally, models incorporating age × gender interactions using splines. The goal is to summarise these results in a unified table to clearly illustrate how effect estimates change when additional demographic and clinical covariates are introduced. This provides a direct comparison of model complexity and helps identify whether non-linearity or interaction effects meaningfully alter the estimated associations.

```{r}
#| label: tbl-all
#| echo: true
#| message: false
#| warning: false

## ---- helper-coef-table -------------------------------------------------
# Reused helper: extract sodium / potassium estimates + SE from a list of models
coef_table <- function(mod_list, model_names,
                       keep_terms = c("sodium", "potassium")) {
  stopifnot(length(mod_list) == length(model_names))
  do.call(rbind, lapply(seq_along(mod_list), function(i) {
    s  <- summary(mod_list[[i]])
    co <- coef(s)
    co <- co[rownames(co) %in% keep_terms, , drop = FALSE]
    data.frame(
      Model    = model_names[i],
      term     = rownames(co),
      estimate = co[, "Estimate"],
      se       = co[, "Std. Error"],
      row.names = NULL
    )
  }))
}

fmt <- function(est, se) sprintf("%.2f (%.2f)", est, se)

## ---- define-model-lists -------------------------------------------------
# Common model labels in the order we want to display them
model_names <- c(
  "Unadjusted",
  "Age",
  "Age+gender",
  "Age+gender+BMI",
  "Age (spline)",
  "Age(spline)+gender",
  "Age(spline)+gender+BMI",
  "Age(spline)×gender",
  "Age(spline)×gender+BMI"
)

# SBP models, in the same order as model_names
model_list_sbp <- list(
  m0,              # Unadjusted
  m1,              # Age
  m2,              # Age+gender
  m3,              # Age+gender+BMI
  m1_ns,           # Age (spline)
  m2_ns,           # Age+gender (spline)
  m3_ns,           # Age+gender+BMI (spline)
  m2_ns_int,       # Age(spline)×gender
  m3_ns_int        # Age(spline)×gender+BMI
)

# DBP models, parallel to SBP
model_list_dbp <- list(
  m4,              # Unadjusted
  m5,              # Age
  m6,              # Age+gender
  m7,              # Age+gender+BMI
  m5_ns,           # Age (spline)
  m6_ns,           # Age+gender (spline)
  m7_ns,           # Age+gender+BMI (spline)
  m6_ns_int,       # Age(spline)×gender
  m7_ns_int        # Age(spline)×gender+BMI
)

## ---- build-wide-tables --------------------------------------------------
# SBP
tab_sbp <- coef_table(model_list_sbp, model_names) |>
  transform(
    value = fmt(estimate, se),
    term  = ifelse(term == "sodium",
                   "Systolic BP Sodium",
                   "Systolic BP Potassium")
  ) |>
  subset(select = c(Model, term, value)) |>
  tidyr::pivot_wider(names_from = term, values_from = value)

# DBP
tab_dbp <- coef_table(model_list_dbp, model_names) |>
  transform(
    value = fmt(estimate, se),
    term  = ifelse(term == "sodium",
                   "Diastolic BP Sodium",
                   "Diastolic BP Potassium")
  ) |>
  subset(select = c(Model, term, value)) |>
  tidyr::pivot_wider(names_from = term, values_from = value)

## ---- merge-sbp-dbp-and-label-types -------------------------------------
# Merge SBP and DBP blocks
table_all <- dplyr::left_join(tab_sbp, tab_dbp, by = "Model")

# Add model type (linear vs spline vs spline×gender)
model_type <- c(
  rep("Linear age",            4),
  rep("Spline age",            3),
  rep("Spline age × gender",   2)
)

table_all <- table_all |>
  dplyr::mutate(
    Model = factor(Model, levels = model_names),
    Model_Type = model_type[match(as.character(Model), model_names)]
  ) |>
  dplyr::relocate(Model_Type, .before = Model) |>
  dplyr::arrange(Model)

## ---- print-table --------------------------------------------------------
k_all <- knitr::kable(
  table_all,
  caption = "Comparison of linear, spline, and spline×gender models for sodium and potassium associations with blood pressure (mmHg/g/day; SE in parentheses).",
  booktabs = TRUE,
  align = c("l", "l", "c", "c", "c", "c")
)

if (requireNamespace("kableExtra", quietly = TRUE)) {
  k_all <- kableExtra::kable_styling(k_all, full_width = FALSE)
}

k_all
```

Across the three fully adjusted specifications: Age+gender+BMI, Age(spline)+gender+BMI, and Age(spline)×gender+BMI from @tbl-all, the estimated associations change notably with increasing model flexibility. For systolic BP, the estimated effect of sodium decreases steadily (0.43 → 0.45 → 0.32 mmHg/g/day), while the potassium effect becomes less negative once nonlinear age terms and interactions are introduced. This pattern suggests that a linear assumption may overstate the magnitude of potassium’s protective association, and that part of the earlier estimate may have been capturing nonlinear age effects rather than a direct dietary association.

The results for diastolic BP are even more striking. The sodium estimate rapidly declines from 0.19 to 0.05 and then to 0.03, values that are nearly indistinguishable from zero and, in both spline models, are smaller than their corresponding standard errors. For potassium, the estimated association changes direction, becoming negative once nonlinear age terms are introduced, indicating that any positive relationship observed in simpler models may be driven by confounding with age.

Overall, these findings highlight the importance of accounting for nonlinear age patterns and potential age–gender interactions when modeling dietary effects. The spline-based models produce smaller and more conservative estimates, and for diastolic BP in particular, they suggest that the linear model may have overstated the strength of association. Taken together, this comparison demonstrates how model specification meaningfully influences inference and reinforces the value of flexible modeling strategies in survey-based epidemiologic analyses.

## **7.3.** Interpretation & Key Insights

The analyses above illustrate how model specification meaningfully shapes the estimated associations between dietary sodium and potassium and blood pressure once survey design and key demographic factors are accounted for. Several consistent themes emerge:

1.  **Age adjustment fundamentally changes interpretation.** The shift from the unadjusted to age-adjusted models produces the largest changes—most notably, a reversal of sign for both nutrients in some outcomes. This confirms age as a major confounder in this context and underscores the need for careful demographic control in nutritional epidemiology.

2.  **Model flexibility alters conclusions, especially for diastolic blood pressure.** Among the three fully adjusted models (linear, spline, and spline×gender), the association patterns evolve progressively:

| Model                  | SBP Sodium | DBP Sodium | DBP Potassium |
|------------------------|------------|------------|---------------|
| Age+gender+BMI         | 0.43       | 0.19       | 0.37          |
| Age(spline)+gender+BMI | 0.45       | 0.05       | –0.14         |
| Age(spline)×gender+BMI | 0.32       | 0.03       | –0.16         |

-   For **systolic BP**, estimates remain positive but decline when nonlinearity and interaction are allowed.
-   For **diastolic BP**, the sodium estimate falls from 0.19 to nearly zero (0.05 → 0.03), with standard errors exceeding the estimates—suggesting limited evidence for any association.
-   For potassium and diastolic BP, the estimate becomes *negative* once spline age terms are introduced—indicating a reversal of direction once age is allowed to vary flexibly.

These patterns suggest that linear adjustment may mask underlying heterogeneity across age and gender. Spline and interaction models likely capture age-specific effects that are otherwise aggregated in simpler specifications.

3.  **Overall effect sizes are modest.** Across all specifications, the magnitudes of coefficients remain small (generally \<1 mmHg per gram/day), consistent with prior literature. The primary insights arise from *how* estimates change with adjustment rather than from their absolute size.

**In summary**, while the associations between sodium, potassium, and blood pressure are modest, they are sensitive to model specification, particularly for diastolic BP. The stepwise analyses show that flexible modeling choices reveal more nuanced patterns, suggesting that dietary associations may interact with age and gender in clinically meaningful ways. The results highlight the importance of considering nonlinearity and demographic interactions when conducting survey-weighted analyses using NHANES data.

# 8. Model Diagnostics

## 8.1. Reproducing Textbook Diagnostics (Fully Adjusted Linear Model)

To ensure fidelity to the original textbook example, we first reproduce the diagnostics conducted by Lumley on the **fully adjusted linear model**. In the textbook (Figure 5.12), diagnostics were applied **only to the final linear model** — the one adjusted for **age, gender, and BMI**.

In our analysis, this model corresponds to **`m3`**, which is defined as:

```{r}
m3 <- svyglm(BPXSAR ~ sodium + potassium + RIDAGEYR + RIAGENDR + BMXBMI, design = des)
```

Lumley used two diagnostic plots:

1.  **Scaled residuals vs fitted values**

2.  **Partial residuals for sodium**

These diagnostics assess whether:

-   The functional form is appropriate (linearity),

-   Residuals show systematic structure (possible misspecification),

-   A more flexible model is warranted (motivation for Section 8.2).

Below we reproduce these diagnostics in our reproducible container environment.

```{r}
#| label: fig-diag-1

nonmissing_m3 <- des[-m3$na.action, ]
par(mfrow = c(2,2))
plot(m3,panel = make.panel.svysmooth(nonmissing_m3), main = "Residuals vs Fitted (Replicating Lumley, Textbook Figure 5.12)")
```

Following Lumley’s textbook diagnostics (Figure 5.12), we first examine the **fully adjusted linear model** (`m3`) using the standard set of residual-based plots:

(i). residuals vs fitted values,

(ii). Q–Q residual plot,

(iii). scale–location plot, and

(iv). residuals vs leverage.

These diagnostics help assess whether the assumed *linear structure* of predictors—including age, gender, BMI, sodium, and potassium—adequately captures the underlying relationship with systolic blood pressure. A well-behaved linear model should show residuals randomly scattered around zero without systematic curvature or strong outliers.

@fig-diag-1 shows the four-panel diagnostic output for model `m3`. Key patterns include:

-   **Residuals vs Fitted**: points remain centered around zero, with no clear curvature—suggesting no major nonlinearity.

-   **Q–Q Plot**: some deviation at upper quantiles indicates mild departure from normality but not severe.

-   **Scale–Location Plot**: a faint upward trend suggests slight heteroscedasticity but still within acceptable limits.

-   **Residuals vs Leverage**: limited influential points with high leverage, but none large enough to distort the model.

Overall, the diagnostic plots are **consistent with Lumley’s findings**—there is no strong evidence of functional misspecification, but mild deviations hint that a more flexible model could capture additional structure.

```{r}
#| label: fig-diag-2

# Choose model to diagnose 
diag_model <- m3  # fully adjusted SBP model 
# Non-missing analytic subset used by diag_model 
nonmissing <- des[-diag_model$na.action, ]

# Extract model frame
mf <- model.frame(nonmissing)

# Define plotting helper
plot_partial <- function(model, var, xlab) {
  f <- fitted(model)
  y <- resid(model)
  x <- mf[[var]]
  ok <- is.finite(x) & is.finite(f) & is.finite(y)
  
  plot(x[ok], y[ok],
       main = paste("Partial residuals for", xlab),
       xlab = xlab, ylab = "Residuals",
       pch = 19, cex = 0.4, col = "grey70")
  lines(lowess(x[ok], y[ok]), col = "blue", lwd = 2)
}

plot_partial(model = m3, var = "sodium", xlab = "Sodium (g/day)")
```

@fig-diag-2 shows the *partial residual plot* for **sodium**, replicating the second panel of Lumley’s diagnostics. Consistent with the textbook example, the partial residuals cluster densely around zero with no clear curvature. The overlaid smoother remains largely flat, indicating that under a fully adjusted linear model, sodium shows a **primarily linear association** with systolic blood pressure—not strongly nonlinear.

This aligns with Lumley’s interpretation that:

> *“There is no suggestion of nonlinearity in the relationship between sodium and blood pressure.”* (Lumley, p. 102)

At the same time, the dispersion increases at higher sodium levels, suggesting that **allowing age to vary nonlinearly** or **interact with sodium** may offer clearer insights, leading naturally to spline and interaction specifications.

In summary, the diagnostics for the fully adjusted linear model reproduce Lumley’s original findings. The model shows reasonable fit and no major violations of linearity—however, subtle trends in the residual structure suggest that **a more flexible specification may better capture age-related variation or effect modification**.

Therefore, in **Section 8.2**, we extend these diagnostics to the spline (`m3_ns`) and interaction (`m3_ns_int`) models to evaluate whether flexible age structures yield improved fit or reveal additional patterns not captured by the linear model.

## 8.2. Diagnostics for Spline and Interaction Models

While the diagnostics in Section 8.1 reproduced Lumley’s conclusion that the fully adjusted linear model shows no major violations of linearity, subtle structure in the residuals suggested that a more flexible age specification may reveal additional patterns.

To evaluate this, we extend the diagnostic procedure to the two models fitted in Section 7:

-   **Spline model (`m3_ns`)**: allows *nonlinear* effects of age
-   **Spline × gender interaction model (`m3_ns_int`)**: allows effect modification

Our goal here is not formal model comparison, but rather to check whether **the shape of the residuals changes** — which may signal that flexibility in age improves model fit.

We apply **the same two diagnostics used in Section 8.1**:

1.  **Residuals vs fitted values** — for overall model adequacy
2.  **Partial residuals for sodium** — to assess whether the sodium effect becomes clearer or more structured under flexible age specification

To maintain reproducibility, we reuse the same plotting functions introduced earlier.

**Model with spline age only (`m3_ns`)**

```{r}
#| label: fig-ns-diag

# Extract non-missing data for spline model
nonmissing_m3_ns <- des[-m3_ns$na.action, ]

par(mfrow= c(2,2))
# Residuals vs fitted plot for spline model
plot(m3_ns,
     panel = make.panel.svysmooth(nonmissing_m3_ns),
     main = "Residuals vs Fitted — Spline Age Model (m3_ns)")
```

The residual–fitted plot from @fig-ns-diag suggests mild funneling at higher predicted values, indicating some remaining heteroscedasticity despite using a spline for age. The scale-location plot reinforces this, with variance still slightly increasing toward the right side. The Q–Q plot shows noticeable right skewness, suggesting heavy tails not fully captured by the model. Finally, the residuals vs leverage plot indicates a few influential points but none exceeding standard thresholds. Overall, the spline model improves flexibility but still leaves some nonlinearity and heteroscedasticity unaccounted for.

**Model with spline × gender interaction (`m3_ns_int`)**

```{r}
#| label: fig-ns-int-diag

# Extract non-missing data for interaction model
nonmissing_m3_ns_int <- des[-m3_ns_int$na.action, ]

par(mfrow= c(2,2))
# Residuals vs fitted plot for interaction model
plot(m3_ns_int,
     panel = make.panel.svysmooth(nonmissing_m3_ns_int),
     main = "Residuals vs Fitted — Interaction Model (m3_ns_int)")
```

Compared to m3_ns, this interaction model slightly improves the spread of residuals and reduces heteroscedasticity, especially among mid-range predicted values. However, the Q–Q plot from @fig-ns-int-diag still shows similar tail behavior, implying that the interaction term does not fully address departures from normality. The leverage plot similarly identifies a few potential influential observations, but no extreme outliers dominate the model. These results suggest that adding the age–gender interaction improves fit marginally but does not address all limitations.

We again generate partial residual plots for **sodium**, focusing on whether nonlinearity is more visible once age is modeled flexibly.

```{r}
#| label: fig-ns-diag-2

# Partial residuals for sodium — spline model
plot_partial(model = m3_ns,
             var   = "sodium",
             xlab  = "Sodium (g/day) — Spline Age Model (m3_ns)")
```

The partial residual plot @fig-ns-diag-2 for sodium under m3_ns shows a largely flat trend, suggesting no strong nonlinear relationship between sodium intake and blood pressure once age and covariates are modeled flexibly. The smooth line has only mild curvature, indicating that while the spline captured age effects, sodium itself does not contribute major nonlinear variation. This aligns with earlier coefficient results, where sodium was significant but effect size remained modest.

```{r}
#| label: fig-ns-int-diag-2

# Partial residuals for sodium — interaction model
plot_partial(model = m3_ns_int,
             var   = "sodium",
             xlab  = "Sodium (g/day) — Spline × Gender Model (m3_ns_int)")
```

The sodium × age interaction partial plot @fig-ns-int-diag-2 reveals slightly more curvature than its non-interaction counterpart, with mild deviation at both tails. This indicates a weak effect modification by age, consistent with our earlier inference. However, the trend remains overall stable, suggesting that while interaction terms help marginally, their contribution to improving prediction or model diagnostics is still limited.

Taken together, these diagnostics confirm that using splines improves fit over the linear m3 model, but the gains are modest. The interaction model (m3_ns_int) performs slightly better, though neither fully addresses issues of non-normality and mild heteroscedasticity. These findings motivate further model refinement, which we explore next in **Section 8.3**, where we compare overall model performance using pseudo-R² and other fit criteria.

## 8.3. Summary of Diagnostic Findings

Across the two spline models, the diagnostics reveal **some improvements compared to the linear model**, but also **persistent departures from ideal model assumptions**.

**First**, both diagnostic figures for the spline models (@fig-ns-diag and @fig-ns-int-diag) indicate a **slight reduction in overall spread of Pearson residuals**, which suggests that allowing nonlinear age effects helps capture additional variability that the linear model could not.

**However**, the Q–Q plots still deviate visibly from the theoretical line, and residuals in the upper tail remain heavy. The **scale–location plots** show a gradual increase in variance as fitted values increase, implying **residual heteroscedasticity remains**.

**Second**, comparing spline-only and spline×gender models (@fig-ns-diag vs. @fig-ns-int-diag), the overall patterns are **highly similar**, indicating that including the interaction term does **not dramatically alter diagnostics**. The leverage plots also highlight a consistent set of influential observations across both models.

Overall:

-   **Spline terms improve the age–BP relationship**, consistent with biological expectations.
-   **Model assumptions are still imperfect**, particularly regarding residual variance and tail behavior.
-   **The gender interaction does not noticeably improve diagnostics.**

These results suggest that while nonlinear age specifications are more appropriate than linear age, **further refinement may be needed**—for example, including additional covariates or reconsidering variance structure.

# 9. More Models

## 9.1. SBP model with interactions (Table 5.2)

We next test whether the effects of sodium and potassium on blood pressure **change with age**.\
To make coefficients easier to interpret, we **center age at 40 years**, following the textbook’s approach.

With this centering:

-   The **main effects** for sodium and potassium represent their estimated effects **at age 40**.

-   The **interaction terms** indicate how those effects **change with each additional year of age**.

This model helps determine whether the association between dietary intake and systolic blood pressure strengthens or weakens as people get older.

```{r}
int_sbp <- svyglm(
  BPXSAR ~ (sodium + potassium) * I(RIDAGEYR - 40)
             + RIAGENDR + BMXBMI, design = des)
# summary(int_sbp)
```

**Interpretation summary:**

-   Coefficients for **sodium** and **potassium** can be interpreted as the estimated change in *systolic blood pressure (mmHg)* per 1 g/day increase in each nutrient **at age 40**.

-   The corresponding **age-interaction coefficients** describe how these effects change per one-year increase in age.

-   A **positive interaction term** implies that the nutrient’s effect on BP becomes stronger (more positive) with age, while a **negative term** means the effect weakens with age.

-   These interaction slopes provide a clearer picture of how nutrient–BP relationships evolve over the lifespan, setting the stage for the diastolic analysis in the next subsection.

## 9.2. DBP model with interactions (Table 5.2)

We now fit the **analogous interaction model** for *diastolic blood pressure (BPXDAR)*.

As in the systolic case, we interact the combined sodium–potassium term with **centered age (RIDAGEYR − 40)** and adjust for gender and BMI.

This specification allows the nutrient–BP relationship to vary with age while maintaining interpretability at the 40-year reference point.

```{r}
int_dbp <- svyglm(
  BPXDAR ~ (sodium + potassium) * I(RIDAGEYR - 40)
             + RIAGENDR + BMXBMI, design = des)
# summary(int_dbp)
```

**Interpretation summary:**

-   As before, the **main effects** for sodium and potassium represent estimated changes in *diastolic blood pressure (mmHg)* per 1 g/day increase **at age 40**.

-   The **interaction coefficients** indicate how these slopes change with each additional year of age.

-   Comparing this model with the systolic version (Section 9.1) helps determine whether age modifies the sodium–potassium effects differently for systolic versus diastolic BP.

-   Typically, the age interactions for diastolic BP are **weaker and less consistent**, suggesting that age-related modulation is more pronounced for systolic pressure.

## 9.3. Table for Age interactions summary

Following the fitted models from **Sections 9.1 and 9.2**, we now summarize the estimated **age interactions** for both systolic (SBP) and diastolic (DBP) blood pressure.

Table 3 presents the coefficients, standard errors, and p-values for sodium and potassium main effects and their corresponding age interactions, using centered age RIDAGEYR−40 to represent changes relative to age 40.

These results replicate **Table 5.2** from the textbook and provide an interpretable summary of how sodium and potassium effects vary with age.

```{r}
#| label: tbl-52-rep
#| echo: true
#| message: false
#| warning: false

# int_sbp and int_dbp already fitted
# Helper to extract rows & format numbers/p-values
tidy_block <- function(mod, terms, term_labels) {
  s  <- summary(mod)
  co <- coef(s)
  co <- co[rownames(co) %in% terms, , drop = FALSE]
  # preserve order of `terms`
  co <- co[match(terms, rownames(co)), , drop = FALSE]
  fmt_p <- function(p) ifelse(p < 0.001, "< 0.001", sprintf("%.3f", p))
  data.frame(
    Term        = term_labels,
    Coefficient = sprintf("%.3f", co[, "Estimate"]),
    `Std Error` = sprintf("%.3f", co[, "Std. Error"]),
    `p-value`   = fmt_p(co[, "Pr(>|t|)"]),
    check.names = FALSE,
    row.names = NULL
  )
}

# Term names as they appear in svyglm()
trms <- c("sodium", "potassium",
          "sodium:I(RIDAGEYR - 40)", "potassium:I(RIDAGEYR - 40)")
labs <- c("Sodium", "Potassium", "Sodium:Age", "Potassium:Age")
sbp_block <- tidy_block(int_sbp, trms, labs)
dbp_block <- tidy_block(int_dbp, trms, labs)

# Merge side-by-side
tab2 <- cbind(
  Term = sbp_block$Term,
  sbp_block[, c("Coefficient","Std Error","p-value")],
  dbp_block[, c("Coefficient","Std Error","p-value")]
)
colnames(tab2) <- c("",
                    "Coefficient","Std Error","p-value",
                    "Coefficient","Std Error","p-value")
k <- knitr::kable(
  tab2,
  caption = "Interactions between age and sodium and potassium intake, data from NHANES 2003–2006",
  booktabs = TRUE,
  align = c("l","c","c","c","c","c","c")
)

# If kableExtra is available, add panel headers for SBP/DBP:
if (requireNamespace("kableExtra", quietly = TRUE)) {
  k <- kableExtra::add_header_above(
    k,
    c(" " = 1, "Systolic BP" = 3, "Diastolic BP" = 3)
  )
}

k
```

The estimates in Table @tbl-52-rep closely mirror those in Lumley’s *Complex Surveys* (@tbl-52-rep), with nearly identical coefficients and standard errors. Minor differences reflect updated weighting and stricter missing-value handling, but the interpretation is unchanged: both sodium and potassium show modest, age-dependent attenuation of their associations with blood pressure.

![Textbook Table 5.2 – Interactions between age and sodium and potassium intake, data from NHANES 2003–2006.](images/clipboard-1497767788.png){#fig-table52}

-   **Main effects (Sodium, Potassium):** Represent the estimated associations with blood pressure at **age 40**, since the models are centered at that age.

-   **Interaction terms (Sodium×Age, Potassium×Age):** Capture how the sodium and potassium effects vary with each additional year of age.\
    Negative coefficients suggest that the association weakens slightly as age increases.

-   **Systolic vs. Diastolic patterns:** Both SBP and DBP models display consistent signs, with potassium generally showing negative associations (protective) and sodium showing positive or near-zero effects. The age interactions are statistically significant for both nutrients, indicating modest age-related attenuation.

Together, these results support the conclusion that the influence of dietary sodium and potassium on blood pressure is **age-dependent but directionally stable** — consistent with the patterns described in the textbook’s Table 5.2.

## 9.4. Additional interaction models (age × gender)

We now test whether the **age gradient** in blood pressure differs between males and females.

To do so, we include an **age × gender interaction term**, while keeping sodium, potassium, and BMI as covariates.

This model examines whether the relationship between age and blood pressure varies by gender, after accounting for key dietary and physiological factors.

Specifically:

-   The **main effect of age** represents the age–BP slope for the **reference gender** (e.g., males if coded as 1).

-   The **interaction term (age × gender)** captures how that slope differs for the other gender.

-   Including both SBP and DBP models allows comparison of whether this age-by-gender effect differs across the two BP outcomes.

```{r}
# SBP model: age × gender interaction
mod_sbp_age_gender <- svyglm(
  BPXSAR ~ sodium + potassium + RIDAGEYR * RIAGENDR + BMXBMI,
  design = des)

# DBP model: age × gender interaction
mod_dbp_age_gender <- svyglm(
  BPXDAR ~ sodium + potassium + RIDAGEYR * RIAGENDR + BMXBMI,
  design = des)

# summary(mod_sbp_age_gender); summary(mod_dbp_age_gender)
```

**Interpretation summary:**

-   A **significant age × gender term** indicates that blood pressure changes with age differently for men and women.

-   If the interaction term is **positive**, it suggests that the age-related increase in BP is steeper in females;\
    if **negative**, the increase is steeper in males.

-   In practice, this interaction is often **smaller for diastolic BP** than for systolic BP, consistent with biological and hormonal differences that moderate age-related effects.

-   These models serve as a precursor to the next section (9.4), where we replace linear age with **natural splines** to allow more flexible gender-specific age trends.

## 9.5. Natural splines for age with gender interaction

To model **nonlinear age effects**, we replace linear age with a **natural spline** (df = 5) and interact it with gender.

This approach allows the shape of the **age–blood pressure (BP)** relationship to differ flexibly between males and females, rather than assuming a simple linear trend.

Conceptually:

-   The spline component models smooth but nonlinear age effects.

-   The age × gender interaction lets the **shape** of the age–BP curve differ by gender, not just the slope.

-   All other covariates (sodium, potassium, BMI) are retained for comparability with prior models.

This specification extends Section 9.3 by allowing men and women to have distinct curvature patterns in their age-related BP trajectories.

```{r}
# SBP model: ns(age, 5) × gender
mod_sbp_ns_age_gender <- svyglm(
  BPXSAR ~ sodium + potassium + ns(RIDAGEYR, 5) * RIAGENDR + BMXBMI,
  design = des
)

# DBP model: ns(age, 5) × gender
mod_dbp_ns_age_gender <- svyglm(
  BPXDAR ~ sodium + potassium + ns(RIDAGEYR, 5) * RIAGENDR + BMXBMI,
  design = des
)

# summary(mod_sbp_ns_age_gender); summary(mod_dbp_ns_age_gender)
```

**Interpretation summary:**

-   **Significant spline × gender terms** suggest that the **shape** of the age–BP curve differs between men and women, beyond simple slope differences.

-   For example, systolic BP may rise earlier or level off later in one gender, reflecting physiological or behavioral factors.

-   If the spline terms are *not* significant, it implies that a simple linear age × gender interaction (as in Section 9.3) already captures most of the gender-specific age pattern.

-   Together, these models confirm whether nonlinearities in the age–BP relationship are meaningful once dietary and body composition effects are controlled.

## 9.6. Marginal effects by age (readable summaries)

To make the interaction models (Sections **9.1–9.2**) more interpretable, we compute **age-specific slopes** for sodium and potassium at several reference ages (e.g., 20, 40, and 60 years).

These values describe how the estimated effects of sodium and potassium on blood pressure **change across the life course**, providing a more intuitive view than interaction coefficients alone.

Because age was **centered at 40 years** in the model, the estimated slope at any age A is given by:

$$
\beta_{\text{sodium}} + (A-40)\times \beta_{\text{sodium:age_c}}
$$

and likewise for potassium.

At age 40, this simplifies to the model’s main effect; at other ages, the slope is adjusted according to the interaction term.

We use a helper function below to compute these linear combinations (with standard errors and p-values) directly from the fitted model’s coefficients and variance–covariance matrix.

```{r}
# Helper to compute age-specific slopes (linear combinations) for sodium/potassium
marginal_slopes <- function(mod, ages = c(20, 40, 60), terms = c("sodium","potassium")) {
  b  <- coef(mod)
  V  <- vcov(mod)
  df <- summary(mod)$df  # design-based df used by svyglm summaries

  build_row <- function(term, age) {
    agec <- age - 40
    main <- term
    inter <- paste0(term, ":age_c")
    if (!all(c(main, inter) %in% names(b))) stop("Term names not found in model: ", term)

    L <- rep(0, length(b)); names(L) <- names(b)
    L[main]  <- 1
    L[inter] <- agec

    est <- sum(L * b)
    se  <- sqrt(as.numeric(t(L) %*% V %*% L))
    tval <- est / se
    pval <- 2 * pt(abs(tval), df = df, lower.tail = FALSE)
    data.frame(term = term, age = age, slope = est, se = se, t = tval, p = pval)
  }

  do.call(rbind, lapply(terms, function(term)
    do.call(rbind, lapply(ages, function(a) build_row(term, a)))
  ))
}
```

**How to interpret the output:**

-   **At age 40:** The slope equals the model’s main effect, since agec=0agec​=0.

-   **At age 60:** Add 20×(interaction coefficient to the main effect — this shows how sodium/potassium effects evolve with age.

-   **At age 20:** Subtract 20×(interaction coefficient) from the main effect to reflect younger age effects.

-   **Reported values** represent the estimated change in **SBP or DBP (mmHg)** per **1 g/day increase** in sodium or potassium intake at the specified age, with standard errors and p-values based on the model’s survey-adjusted variance estimates.
