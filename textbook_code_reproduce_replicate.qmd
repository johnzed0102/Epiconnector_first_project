---
title: "Textbook Code Reproduce"
author: "Johnny Zhao"
format: docx
editor: visual
---

## Figure 5.9 – Loading and merging data from NHANES 2003–2004 and NHANES 2005—2006

```{r}
library(foreign)
setwd("~/Desktop/Epiconnector/NHANES")

demo <- read.xport("demo_c.xpt")[, c("SEQN", "SDDSRVYR", "RIDSTATR", "RIDEXMON", 
                                     "RIAGENDR", "RIDAGEYR", "RIDAGEMN", "RIDAGEEX", 
                                     "WTINT2YR", "WTMEC2YR", "SDMVPSU", "SDMVSTRA")]
bp <- read.xport("bpx_c.xpt")
bm <- read.xport("bmx_c.xpt")[, c("SEQN","BMXBMI")]
diet <- read.xport("dr1tot_c.xpt")[, c(1:52,63,64)]

nhanes34 <- merge(demo, bp, by="SEQN")
nhanes34 <- merge(nhanes34, bm, by="SEQN")
nhanes34 <- merge(nhanes34, diet, by="SEQN")

demo5 <- read.xport("demo_d.xpt")[, c("SEQN", "SDDSRVYR", "RIDSTATR", "RIDEXMON", 
                                      "RIAGENDR", "RIDAGEYR", "RIDAGEMN", "RIDAGEEX", 
                                      "WTINT2YR", "WTMEC2YR", "SDMVPSU", "SDMVSTRA")]
bp5 <- read.xport("bpx_d.xpt")
bp5$BPXSAR <- rowMeans(bp5[,c("BPXSY1","BPXSY2","BPXSY3",
                              "BPXSY4")], na.rm=TRUE)
bp5$BPXDAR <- rowMeans(bp5[,c("BPXDI1","BPXDI2","BPXDI3",
                              "BPXDI4")], na.rm=TRUE)
bm5 <- read.xport("bmx_d.xpt")[,c("SEQN","BMXBMI")]
diet5 <- read.xport("dr1tot_d.xpt")[,c(1:52,64,65)]

nhanes56 <- merge(demo5,bp5,by="SEQN")
nhanes56 <- merge(nhanes56,bm5,by="SEQN")
nhanes56 <- merge(nhanes56,diet5,by="SEQN")

nhanes <- rbind(nhanes34, nhanes56)
nhanes$fouryearwt <- nhanes$WTDRD1/2
des <- svydesign(id=~SDMVPSU,strat=~SDMVSTRA,weights=~fouryearwt,
                 nest=TRUE, data=subset(nhanes, !is.na(WTDRD1)))
des <- update(des, sodium=DR1TSODI/1000, potassium=DR1TPOTA/1000)
```

## Table 5.1 – Associations between dietary sodium and potassium and blood pressure in NHANES 2003–2006. The units for all coefficients are mmHg/g/day. Standard errors are given in parentheses

```{r}
model0 <- svyglm(BPXSAR~sodium+potassium, design=des) # unadjusted systolic
summary(model0)
model1 <- svyglm(BPXSAR~sodium+potassium+RIDAGEYR, design=des) # adjusted systolic for age
summary(model1)
model2 <- svyglm(BPXSAR~sodium+potassium+RIDAGEYR+RIAGENDR, design=des) # adjusted systolic for age, gender
summary(model2)
model3 <- svyglm(BPXSAR~sodium+potassium+RIDAGEYR+RIAGENDR+BMXBMI, design=des) # adjusted systolic for age, gender, BMI
summary(model3)

model4 <- svyglm(BPXDAR~sodium+potassium, design=des) # unadjusted diastolic
summary(model4)
model5 <- svyglm(BPXDAR~sodium+potassium+RIDAGEYR, design=des) # adjusted diastolic for age
summary(model5)
model6 <- svyglm(BPXDAR~sodium+potassium+RIDAGEYR+RIAGENDR, design=des) # adjusted diastolic for age, gender
summary(model6)
model7 <- svyglm(BPXDAR~sodium+potassium+RIDAGEYR+RIAGENDR+BMXBMI, design=des) # adjusted diastolic for age, gender, BMI
summary(model7)

regTermTest(model3, ~potassium+sodium, df=NULL)
```

Table 5.1 Associations between dietary sodium and potassium and blood pressure in NHANES 2003–2006.\
The units for all coefficients are mmHg/g/day. Standard errors are given in parentheses.

| Model | Systolic BP Sodium | Systolic BP Potassium | Diastolic BP Sodium | Diastolic BP Potassium |
|----|----|----|----|----|
| Unadjusted | -0.69 (0.17) | 0.78 (0.27) | -0.05 (0.11) | 0.88 (0.21) |
| Age and gender | 0.59 (0.16) | -1.09 (0.18) | 0.35 (0.10) | 0.26 (0.19) |
| Age, gender, BMI | 0.43 (0.16) | -0.96 (0.17) | 0.19 (0.10) | 0.38 (0.18) |

There is no clear relationship, and in fact a suggestion that blood pressure decreases as sodium intake increases.

## Table 5.2 – Interactions between age and sodium and potassium intake, data from NHANES 2003–2006

```{r}
int1<-svyglm(BPXSAR ~ (sodium + potassium)*I(RIDAGEYR-40)
             +RIAGENDR + BMXBMI, design = des)
summary(int1)

int2<-svyglm(BPXDAR ~ (sodium + potassium)*I(RIDAGEYR-40)
             +RIAGENDR + BMXBMI, design = des)
summary(int2)
```

Table 5.2. Interactions between age and sodium and potassium intake, data from NHANES 2003–2006

|               | Systolic BP |           |          | Diastolic BP |           |          |
|---------------|-------------|-----------|----------|--------------|-----------|----------|
|               | Coefficient | Std Error | p-value  | Coefficient  | Std Error | p-value  |
| Sodium        | 0.310       | 0.166     | 0.075    | 0.310        | 0.114     | 0.012    |
| Potassium     | -0.976      | 0.183     | \< 0.001 | 0.326        | 0.182     | 0.087    |
| Sodium:Age    | -0.016      | 0.009     | 0.086    | 0.045        | 0.007     | \< 0.001 |
| Potassium:Age | -0.040      | 0.010     | \< 0.001 | -0.037       | 0.007     | \< 0.001 |

## **Figure 5.10 –** Dietary sodium and systolic blood pressure, from NHANES 2003–2006

```{r}
df <- if (exists("des") && !is.null(des$variables)) des$variables else stop("need des")

x <- as.numeric(df$sodium)
y <- as.numeric(df$BPXSAR)
ok <- is.finite(x) & is.finite(y)
x <- x[ok]; y <- y[ok]

xlim_use <- stats::quantile(x, c(0.01, 0.99), na.rm = TRUE)
ylim_use <- stats::quantile(y, c(0.01, 0.99), na.rm = TRUE)

plot(x, y,
     pch = 16, cex = 0.45, col = grDevices::adjustcolor("grey40", alpha.f = 0.25),
     xlab = "Dietary sodium (g/day)", ylab = "Systolic BP (mmHg)",
     xlim = xlim_use, ylim = ylim_use)

sm <- stats::lowess(x, y, f = 0.5)
lines(sm, col = "black", lwd = 2)
```

## **Figure 5.11** – Dietary sodium and systolic blood pressure, by age, from NHANES 2003–2006

```{r}
library(survey)

if (!"sodium" %in% names(des$variables)) {
  des <- update(des, sodium = DR1TSODI/1000)
}

des_ok <- subset(des, is.finite(sodium) & is.finite(BPXSAR) & is.finite(RIDAGEYR))

breaks <- c(0, 20, 30, 40, 50, 60, 80)
labs   <- c("0–19", "20–29", "30–39", "40–49", "50–59", "60–79")
des_ok <- update(des_ok, agegrp = cut(RIDAGEYR, breaks = breaks, right = FALSE, labels = labs))

df_all <- model.frame(des_ok)
x_all  <- df_all$sodium; y_all <- df_all$BPXSAR
xlim_use <- quantile(x_all, c(0.01, 0.99), na.rm = TRUE)
ylim_use <- quantile(y_all, c(0.01, 0.99), na.rm = TRUE)

op <- par(mfrow = c(2,3), mar = c(4,4,2,1))
on.exit(par(op), add = TRUE)

for (g in labs) {
  dfg <- subset(df_all, agegrp == g)
  x <- dfg$sodium; y <- dfg$BPXSAR
  ok <- is.finite(x) & is.finite(y)
  x <- x[ok]; y <- y[ok]
  
  plot(x, y,
       pch = 16, cex = 0.4, col = adjustcolor("grey40", 0.25),
       xlab = "Dietary sodium (g/day)", ylab = "Systolic BP (mmHg)",
       xlim = xlim_use, ylim = ylim_use,
       main = g)
  
  draw_weighted <- FALSE
  try({
    des_g <- subset(des_ok, agegrp == g & is.finite(sodium) & is.finite(BPXSAR))
    sm <- svysmooth(BPXSAR ~ sodium, design = des_g, ngrid = 200)
    if (length(sm$x) > 0 && any(is.finite(sm$y))) {
      lines(sm$x, sm$y, col = "black", lwd = 2)
      draw_weighted <- TRUE
    }
  }, silent = TRUE)
  
  if (!draw_weighted && length(x) > 1) {
    sm2 <- lowess(x, y, f = 0.5)
    lines(sm2, col = "black", lwd = 2, lty = 1)
  }
}
```

Figure 5.11 shows the relationship between blood pressure and dietary sodium for six age groups, and there is now a suggestion of an increase, especially at younger ages.

## **Figure 5.12** – Diagnostic plots. The left-hand panel shows scaled residuals vs fitted values, and smooth mean curves with bandwidths of 5 and 10 mmHg. The right-hand panel shows partial residuals for sodium intake, with the fitted straight line (solid) and a smooth curve(dashed).

```{r}
library(survey)

stopifnot(exists("model3"), inherits(model3, "svyglm"))

nonmissing <- des[-model3$na.action, ]

fit  <- as.numeric(fitted(model3))
resP <- as.numeric(residuals(model3, type = "pearson"))

nonmissing <- update(nonmissing, fit = fit, resP = resP)

par(mfrow = c(1,2), mar = c(4,4,2,1))

plot(fit, resP,
     pch = 16, cex = 0.4, col = adjustcolor("grey40", 0.25),
     xlab = "fitted values", ylab = "residuals")

ok_w <- FALSE
try({
  sm5  <- svysmooth(resP ~ fit, design = nonmissing, bandwidth = 5)
  sm10 <- svysmooth(resP ~ fit, design = nonmissing, bandwidth = 10)
  lines(sm5$x,  sm5$y,  lwd = 2, lty = 1)
  lines(sm10$x, sm10$y, lwd = 2, lty = 2)
  ok_w <- TRUE
}, silent = TRUE)

if (!ok_w) {
  lo <- lowess(fit, resP, f = 0.5)
  lines(lo, lwd = 2, lty = 2)
}

beta_sod <- coef(model3)["sodium"]
res_raw <- as.numeric(residuals(model3, type = "response"))
sod     <- nonmissing$variables$sodium
partres <- res_raw + beta_sod * sod

plot(sod, partres,
     pch = 16, cex = 0.4, col = adjustcolor("grey40", 0.25),
     xlab = "sodium", ylab = "partial residuals")

abline(a = 0, b = beta_sod, lwd = 2)

ok_w2 <- FALSE
try({
  nonmissing <- update(nonmissing, partres = partres)
  smp <- svysmooth(partres ~ sodium, design = nonmissing, ngrid = 200)
  lines(smp$x, smp$y, lwd = 2, lty = 2)
  ok_w2 <- TRUE
}, silent = TRUE)

if (!ok_w2) {
  lo2 <- lowess(sod, partres, f = 0.5)
  lines(lo2, lwd = 2, lty = 2)
}

par(mfrow = c(1,1))
```

Figure 5.12 suggests that the fitted model is adequate and there’s no evidence of nonlinearity in the sodium–blood pressure relationship.

## Graphs Not Shown

```{r}
nonmissing<-des[-model1$na.action]
plot(model1, panel=make.panel.svysmooth(nonmissing))
termplot(model1, data=model.frame(nonmissing),
         partial=TRUE, se=TRUE,
         smooth=make.panel.svysmooth(nonmissing))
```
